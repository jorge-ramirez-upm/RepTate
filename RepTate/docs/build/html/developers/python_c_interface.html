

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tutorial: Interfacing Python and C code &#8212; RepTate 0.9.3 20180719 documentation</title>
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.9.3 20180719',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../_static/Reptate64.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Code Diagrams for GUI" href="callgraphGUI.html" />
    <link rel="prev" title="Tutorial: Adding new functionality to RepTate" href="functionality.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="callgraphGUI.html" title="Code Diagrams for GUI"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="functionality.html" title="Tutorial: Adding new functionality to RepTate"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RepTate 0.9.3 20180719 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="developers.html" accesskey="U">RepTate for developers</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/RepTatelogo.jpg" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorial: Interfacing Python and C code</a><ul>
<li><a class="reference internal" href="#goals">Goals</a></li>
<li><a class="reference internal" href="#our-c-code">Our C code</a></li>
<li><a class="reference internal" href="#compile-the-c-code-into-a-library">Compile the C code into a library</a></li>
<li><a class="reference internal" href="#use-a-c-library-in-python">Use a C library in Python</a><ul>
<li><a class="reference internal" href="#read-the-c-library">Read the C library</a></li>
<li><a class="reference internal" href="#use-library-functions">Use library functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#final-comments">Final comments</a></li>
<li><a class="reference internal" href="#bonus-callback-function">Bonus: Callback function</a><ul>
<li><a class="reference internal" href="#modify-the-c-code">Modify the C code</a></li>
<li><a class="reference internal" href="#modify-the-python-code">Modify the Python code</a></li>
<li><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="functionality.html"
                        title="previous chapter">Tutorial: Adding new functionality to RepTate</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="callgraphGUI.html"
                        title="next chapter">Code Diagrams for GUI</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/developers/python_c_interface.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorial-interfacing-python-and-c-code">
<h1>Tutorial: Interfacing Python and C code<a class="headerlink" href="#tutorial-interfacing-python-and-c-code" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#goals" id="id4">Goals</a></li>
<li><a class="reference internal" href="#our-c-code" id="id5">Our C code</a></li>
<li><a class="reference internal" href="#compile-the-c-code-into-a-library" id="id6">Compile the C code into a library</a></li>
<li><a class="reference internal" href="#use-a-c-library-in-python" id="id7">Use a C library in Python</a><ul>
<li><a class="reference internal" href="#read-the-c-library" id="id8">Read the C library</a></li>
<li><a class="reference internal" href="#use-library-functions" id="id9">Use library functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#final-comments" id="id10">Final comments</a></li>
<li><a class="reference internal" href="#bonus-callback-function" id="id11">Bonus: Callback function</a><ul>
<li><a class="reference internal" href="#modify-the-c-code" id="id12">Modify the C code</a></li>
<li><a class="reference internal" href="#modify-the-python-code" id="id13">Modify the Python code</a></li>
<li><a class="reference internal" href="#usage" id="id14">Usage</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="goals">
<h2><a class="toc-backref" href="#id4">Goals</a><a class="headerlink" href="#goals" title="Permalink to this headline">¶</a></h2>
<p>In this section, we will show how to create a new Python function that makes use of C code
for computations and that can be later used in a theory or view.</p>
<p>Python offers rapid application development because it easier to write, to read (and therefore to maintain) than C code.
However, Python code used for number crunching might be 10 to 100 times slower than C
when Python <a class="reference external" href="http://www.numpy.org">NumPy</a> or <a class="reference external" href="https://www.scipy.org/scipylib/index.html">SciPy</a>
libraries (written in C/C++ or Fortran) cannot be used.</p>
<p>Fortunately, there are many solutions available to write code that will run fast in Python.
We can cite <a class="reference external" href="http://cython.org">Cython</a> or <a class="reference external" href="https://numba.pydata.org">Numba</a> that
transform Python code into C executable and require minimal addition to the existing Python
code. There is also <a class="reference external" href="https://docs.python.org/3.6/library/ctypes.html">Ctypes</a> that provides
C compatible data types, and allows calling functions
from external libraries, e.g. calling pre-compiled C functions. It is a very effective means to communicate with existing C code.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All these solutions require a C compiler installed on your machine.</p>
</div>
<p>In RepTate, some theories (most notably the React application theories) are written in C code and interfaced with Python using,
<a class="reference external" href="https://docs.python.org/3.6/library/ctypes.html">Ctypes</a>.</p>
<p>In general, already-written C code will require <strong>no</strong> modifications to be used by Python.
The only work we need to do to integrate C code in Python is on Python’s side.</p>
<p>The steps for interfacing Python with C using
<a class="reference external" href="https://docs.python.org/3.6/library/ctypes.html">Ctypes</a>. are:</p>
<ol class="arabic simple">
<li>write C code functions</li>
<li>compile the C code as a shared library</li>
<li>write some Python lines of code to “extract” the C functions from the library</li>
<li>run!</li>
</ol>
</div>
<div class="section" id="our-c-code">
<h2><a class="toc-backref" href="#id5">Our C code</a><a class="headerlink" href="#our-c-code" title="Permalink to this headline">¶</a></h2>
<p>As an example of C function, we write a simple function that takes as input
an array of double and return the square. It is evident that such a simple function
(that calculates the square of an array) does not justify the use of C, but it is a good place
to start.</p>
<p>In a new text file, write the code below and save it as <code class="docutils literal"><span class="pre">basic_function.c</span></code> in the folder
<code class="docutils literal"><span class="pre">theories/</span></code> for example:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">c_square</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">array_in</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">array_out</span><span class="p">)</span>
<span class="p">{</span> <span class="c1">//return the square of array_in of length n in array_out</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">array_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">array_in</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="compile-the-c-code-into-a-library">
<h2><a class="toc-backref" href="#id6">Compile the C code into a library</a><a class="headerlink" href="#compile-the-c-code-into-a-library" title="Permalink to this headline">¶</a></h2>
<p>First, make sure you have a C compiler installed on you machine.
Mac and Linux machines usually have a C compiler installed by default.
On Windows, we suggest to install <a class="reference external" href="https://anaconda.org/anaconda/mingw">MinGW</a>
via Anaconda.</p>
<p>To compile the above C function into a library that can later be used by Python,
open a terminal and change the working directory to the folder where <code class="docutils literal"><span class="pre">basic_function.c</span></code>
is located. Then compile the library.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>This new library can only be used by the same type of machine is was
compiled on, i.e., a Windows machine creates libraries that cannot be
used on Linux or Mac, and vice versa.
To avoid problem, we name these library differently: we append to the
library name</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">_win32</span></code> for Windows,</li>
<li><code class="docutils literal"><span class="pre">_darwin</span></code> for Max,</li>
<li><code class="docutils literal"><span class="pre">_linux</span></code> for Linux.</li>
</ul>
</div>
<p>Compile the C file using either</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ gcc -o basic_function_win32.so -shared -fPIC -O2 basic_function.c <span class="c1"># Windows</span>

$ gcc -o basic_function_darwin.so -shared -fPIC -O2 basic_function.c <span class="c1"># Mac</span>

$ gcc -o basic_function_linux.so -shared -fPIC -O2 basic_function.c <span class="c1"># Linux</span>
</pre></div>
</div>
<p>This created a new file <code class="docutils literal"><span class="pre">basic_function_***.so</span></code> containing our C function in the RepTate
folder <code class="docutils literal"><span class="pre">theories/</span></code>.</p>
</div>
<div class="section" id="use-a-c-library-in-python">
<h2><a class="toc-backref" href="#id7">Use a C library in Python</a><a class="headerlink" href="#use-a-c-library-in-python" title="Permalink to this headline">¶</a></h2>
<div class="section" id="read-the-c-library">
<h3><a class="toc-backref" href="#id8">Read the C library</a><a class="headerlink" href="#read-the-c-library" title="Permalink to this headline">¶</a></h3>
<p>We use the <code class="docutils literal"><span class="pre">basic_function.so</span></code> library via
<a class="reference external" href="https://docs.python.org/3.6/library/ctypes.html">Ctypes</a>.
In a new file, write the following and save it as, for example,
<code class="docutils literal"><span class="pre">basic_function_helper.py</span></code></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Define the C-variables and functions from the C-files that are needed in Python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_double</span><span class="p">,</span> <span class="n">c_int</span><span class="p">,</span> <span class="n">CDLL</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">lib_path</span> <span class="o">=</span> <span class="s1">&#39;theories/basic_function_</span><span class="si">%s</span><span class="s1">.so&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">basic_function_lib</span> <span class="o">=</span> <span class="n">CDLL</span><span class="p">(</span><span class="n">lib_path</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;OS </span><span class="si">%s</span><span class="s1"> not recognized&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">))</span>

<span class="n">python_c_square</span> <span class="o">=</span> <span class="n">basic_function_lib</span><span class="o">.</span><span class="n">c_square</span>
<span class="n">python_c_square</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</td></tr></table></div>
<p>Some explainations:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">c_double</span><span class="p">,</span> <span class="n">c_int</span><span class="p">,</span> <span class="n">CDLL</span>
</pre></div>
</div>
<p>imports the Python Ctypes object we will be needing.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">lib_path</span> <span class="o">=</span> <span class="s1">&#39;theories/basic_function_</span><span class="si">%s</span><span class="s1">.so&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
</pre></div>
</div>
<p>defines the path of our library file, and <code class="docutils literal"><span class="pre">sys.platform</span></code> returns either
<code class="docutils literal"><span class="pre">win32</span></code>, <code class="docutils literal"><span class="pre">darwin</span></code> or <code class="docutils literal"><span class="pre">linux</span></code>. Note that the path is relative to the path of
<code class="docutils literal"><span class="pre">RepTate.py</span></code> or <code class="docutils literal"><span class="pre">RepTateCL.py</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">basic_function_lib</span> <span class="o">=</span> <span class="n">CDLL</span><span class="p">(</span><span class="n">lib_path</span><span class="p">)</span>
</pre></div>
</div>
<p>defines the Python object <code class="docutils literal"><span class="pre">square_lib</span></code> where all the functions and variables
from our C file <code class="docutils literal"><span class="pre">basic_function.c</span></code> are stored. In particular, the function
<code class="docutils literal"><span class="pre">c_square</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python_c_square</span> <span class="o">=</span> <span class="n">basic_function_lib</span><span class="o">.</span><span class="n">c_square</span>
</pre></div>
</div>
<p>defines the Python equivalent of the C function <code class="docutils literal"><span class="pre">c_square</span></code>. We name it
<code class="docutils literal"><span class="pre">python_c_square</span></code> for clarity, but using the same name is acceptable.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python_c_square</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>defines what type of variables the C function returns.
In our case, it is <code class="docutils literal"><span class="pre">void</span></code>, which translates in Python to <code class="docutils literal"><span class="pre">None</span></code>.
See <a class="reference external" href="https://docs.python.org/3.6/library/ctypes.html#fundamental-data-types">fundamental-data-types</a> for
a list of equivalence.</p>
</div>
<div class="section" id="use-library-functions">
<h3><a class="toc-backref" href="#id9">Use library functions</a><a class="headerlink" href="#use-library-functions" title="Permalink to this headline">¶</a></h3>
<p>Our C function <code class="docutils literal"><span class="pre">c_square</span></code> accepts three arguments: an <code class="docutils literal"><span class="pre">int</span></code> and two
<code class="docutils literal"><span class="pre">double</span> <span class="pre">*</span></code>. Hence, our Python function <code class="docutils literal"><span class="pre">python_c_square</span></code> accepts three
arguments too but they must by of type <code class="docutils literal"><span class="pre">c_int</span></code> and “array of c_double”
defined by the <code class="docutils literal"><span class="pre">ctypes</span></code> Python library.</p>
<p>Therefore, to use <code class="docutils literal"><span class="pre">python_c_square</span></code>, we have to convert Python integer into
<code class="docutils literal"><span class="pre">c_int</span></code> type and Python list into an “array of c_double”.</p>
<p>The best way to do so is to write a Python function, in the file
<code class="docutils literal"><span class="pre">basic_function_helper.py</span></code></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">do_square_using_c</span><span class="p">(</span><span class="n">list_in</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call C function to calculate squares&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_in</span><span class="p">)</span>
    <span class="n">c_arr_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">n</span><span class="p">)(</span><span class="o">*</span><span class="n">list_in</span><span class="p">)</span>
    <span class="n">c_arr_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">n</span><span class="p">)()</span>

    <span class="n">python_c_square</span><span class="p">(</span><span class="n">c_int</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">c_arr_in</span><span class="p">,</span> <span class="n">c_arr_out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c_arr_out</span><span class="p">[:]</span>
</pre></div>
</td></tr></table></div>
<p>In details:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">c_arr_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">n</span><span class="p">)(</span><span class="o">*</span><span class="n">list_in</span><span class="p">)</span>
<span class="n">c_arr_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">n</span><span class="p">)()</span>
</pre></div>
</div>
<p>defines two <code class="docutils literal"><span class="pre">ctypes</span></code> arrays of <code class="docutils literal"><span class="pre">double</span></code> of size <code class="docutils literal"><span class="pre">n</span></code>
that can be used by the C function. The first one is initialised with the values of <code class="docutils literal"><span class="pre">list_in</span></code>.
It is equivalent to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">c_arr_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_double</span><span class="p">(</span><span class="n">list_in</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
<p>This line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">python_c_square</span><span class="p">(</span><span class="n">c_int</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">c_arr_in</span><span class="p">,</span> <span class="n">c_arr_out</span><span class="p">)</span>
</pre></div>
</div>
<p>calls the C function that does the computation of the square of <code class="docutils literal"><span class="pre">c_arr_in</span></code>
and put the result in <code class="docutils literal"><span class="pre">c_arr_out</span></code>. Note the conversion <code class="docutils literal"><span class="pre">c_int(n)</span></code> that
transforms the Python integer into a <code class="docutils literal"><span class="pre">ctypes</span></code> <code class="docutils literal"><span class="pre">int</span></code>.</p>
<p>This line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">c_arr_out</span><span class="p">[:]</span>
</pre></div>
</div>
<p>returns a copy of the results as a Python list.</p>
</div>
</div>
<div class="section" id="final-comments">
<h2><a class="toc-backref" href="#id10">Final comments</a><a class="headerlink" href="#final-comments" title="Permalink to this headline">¶</a></h2>
<p>Our C function <code class="docutils literal"><span class="pre">c_square</span></code> is now wrapped into a Python function
<code class="docutils literal"><span class="pre">do_square_using_c</span></code>. To use it in a RepTate module, simply import the
function by including in the module header.</p>
<p>As an example, the following calculates the square of numbers from 0 to 999:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">basic_function_helper</span> <span class="k">import</span> <span class="n">do_square_using_c</span>
<span class="o">...</span>
<span class="n">my_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">squared_list</span> <span class="o">=</span> <span class="n">do_square_using_c</span><span class="p">(</span><span class="o">*</span><span class="n">my_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="bonus-callback-function">
<h2><a class="toc-backref" href="#id11">Bonus: Callback function</a><a class="headerlink" href="#bonus-callback-function" title="Permalink to this headline">¶</a></h2>
<p>We presented above a method to have Python “request something from C”, that is,
Python calls a C function and gets an answer. In the previous example, Python requested
C to calculate the square of an array.
Sometimes, it is convenient to do the other way around too. For instance, if the array
is “big”, the C function might take some time to finish the calculations, and we may want
to inform Python of the advancement of the computations.</p>
<p>We propose here to modify the above code to include a <em>callback</em> function that lets
the C code call a Python function.
As a simple example, the C code will request Python to print the advancement of the
calculations of the “square” function, previously introduced.
It require more steps than what we have seen before, but it is reasonably simple.</p>
<p>The C function will call a Python function with a <code class="docutils literal"><span class="pre">double</span></code> argument (the advancement in percent)
and Python will return the percentage incremented by 20%.</p>
<div class="section" id="modify-the-c-code">
<h3><a class="toc-backref" href="#id12">Modify the C code</a><a class="headerlink" href="#modify-the-c-code" title="Permalink to this headline">¶</a></h3>
<p>We need to define:</p>
<ul class="simple">
<li>A proxy function that will be used to call the corresponding Python function</li>
<li><dl class="first docutils">
<dt>A function that Python will initially call to define the proxy function.</dt>
<dd>This is similar to what we have done so far.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>A function <em>type</em> that defines how the proxy function “look” like, i.e.</dt>
<dd>arguments and return types (<code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">double</span></code>, etc.)</dd>
</dl>
</li>
</ul>
<p>Somewhere before the <code class="docutils literal"><span class="pre">c_square</span></code> function definition, we write:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="kt">double</span> <span class="nf">give_and_take_double</span><span class="p">(</span><span class="kt">double</span> <span class="n">p</span><span class="p">);</span> <span class="c1">// type definition</span>
<span class="n">give_and_take_double</span> <span class="o">*</span><span class="n">tell_python</span><span class="p">;</span>             <span class="c1">// pointer to a function of type &quot;give_and_take_double&quot;</span>
<span class="kt">void</span> <span class="nf">def_python_callback</span><span class="p">(</span><span class="n">give_and_take_double</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Function called by Python once</span>
    <span class="c1">// Defines what &quot;tell_python&quot; is pointing to</span>
    <span class="n">tell_python</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first line defines a new type: a function that takes a single <code class="docutils literal"><span class="pre">double</span></code> as argument and returns a <code class="docutils literal"><span class="pre">double</span></code>.
This allows us to define the second line: a pointer to a function of type <code class="docutils literal"><span class="pre">give_and_take_double</span></code>.
At this point we do not know that the function will be, but we know it accepts a <code class="docutils literal"><span class="pre">double</span></code> as argument, and
it returns a <code class="docutils literal"><span class="pre">double</span></code>. The last lines consist of the function that Python will have to call to actually define what <code class="docutils literal"><span class="pre">tell_python</span></code> is,
or rather, define towards what it is pointing to.</p>
<p>Now we can decorate our <code class="docutils literal"><span class="pre">c_square</span></code> function with the <code class="docutils literal"><span class="pre">tell_python</span></code> function:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">c_square</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">array_in</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">array_out</span><span class="p">)</span>
<span class="p">{</span> <span class="c1">//return the square of array_in of length n in array_out</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">percent</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">i</span> <span class="o">/</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">percent</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="n">tell_python</span><span class="p">(</span><span class="n">percent</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">array_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">array_in</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That is all we need to do on the C side.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Do not forget to recompile the shared library every time you modify the C code.</p>
</div>
</div>
<div class="section" id="modify-the-python-code">
<h3><a class="toc-backref" href="#id13">Modify the Python code</a><a class="headerlink" href="#modify-the-python-code" title="Permalink to this headline">¶</a></h3>
<p>Last steps, we need to modify the Python code.
We make some addition to the file “basic_function_helper.py”.
We need to:</p>
<ul class="simple">
<li>Define a “classic” Python function</li>
<li>Define a C callback function that translates that Python function</li>
<li>Call the C function <code class="docutils literal"><span class="pre">def_python_callback</span></code>, defined above to setup the callback function</li>
</ul>
<p>We add to the bottom of the file “basic_function_helper.py”:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Callback stuff</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">CFUNCTYPE</span><span class="p">,</span> <span class="n">POINTER</span>

<span class="k">def</span> <span class="nf">get_percent</span><span class="p">(</span><span class="n">percent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print advancement and set the next call when C has advanced a further 20%&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Qprint</span><span class="p">(</span><span class="s2">&quot;Advancement of C calculations: </span><span class="si">%f%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">percent</span> <span class="o">+</span> <span class="mf">0.2</span>

<span class="n">CB_FTYPE_DOUBLE_DOUBLE</span> <span class="o">=</span> <span class="n">CFUNCTYPE</span><span class="p">(</span><span class="n">c_double</span><span class="p">,</span> <span class="n">c_double</span><span class="p">)</span> <span class="c1"># define C pointer to a function type</span>
<span class="n">cb_get_percent</span> <span class="o">=</span> <span class="n">CB_FTYPE_DOUBLE_DOUBLE</span><span class="p">(</span><span class="n">get_percent</span><span class="p">)</span> <span class="c1"># define a C function equivalent to the python function &quot;get_percent&quot;</span>
<span class="n">basic_function_lib</span><span class="o">.</span><span class="n">def_python_callback</span><span class="p">(</span><span class="n">cb_get_percent</span><span class="p">)</span>  <span class="c1"># the the C code about that C function</span>
</pre></div>
</div>
<p>In these lines:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_percent</span><span class="p">(</span><span class="n">percent</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>we define a “classic” Python function that take a <code class="docutils literal"><span class="pre">float</span></code> as argument, and return a <code class="docutils literal"><span class="pre">float</span></code>.
It prints the information in the theory text box of RepTate via the Qprint method.</p>
<p>Then, in the line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CB_FTYPE_DOUBLE_DOUBLE</span> <span class="o">=</span> <span class="n">CFUNCTYPE</span><span class="p">(</span><span class="n">c_double</span><span class="p">,</span> <span class="n">POINTER</span><span class="p">(</span><span class="n">c_double</span><span class="p">))</span>
</pre></div>
</div>
<p>the first argument of the ctypes function <code class="docutils literal"><span class="pre">CFUNCTYPE</span></code> defines the return types (here <code class="docutils literal"><span class="pre">double</span></code>) and the other arguments
are the function arguments (here only one <code class="docutils literal"><span class="pre">double</span></code>). <code class="docutils literal"><span class="pre">CFUNCTYPE</span></code> returns a pointer to a C functions:</p>
<p>The following line defines a C function of type <code class="docutils literal"><span class="pre">CB_FTYPE_DOUBLE_DOUBLE</span></code>, which is a proxy for the Python
function <code class="docutils literal"><span class="pre">get_percent</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cb_get_percent</span> <span class="o">=</span> <span class="n">CB_FTYPE_DOUBLE_DOUBLE</span><span class="p">(</span><span class="n">get_percent</span><span class="p">)</span>
</pre></div>
</div>
<p>Then we tell our C code which is our callback function:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">basic_function_lib</span><span class="o">.</span><span class="n">def_python_callback</span><span class="p">(</span><span class="n">cb_get_percent</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h3><a class="toc-backref" href="#id14">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h3>
<p>Now we can calculate the square of a “big” list and follow the advancement of the computations in the theory text box.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="callgraphGUI.html" title="Code Diagrams for GUI"
             >next</a> |</li>
        <li class="right" >
          <a href="functionality.html" title="Tutorial: Adding new functionality to RepTate"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RepTate 0.9.3 20180719 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="developers.html" >RepTate for developers</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Universidad Politécnica de Madrid, University of Leeds.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.4.
    </div>
  </body>
</html>