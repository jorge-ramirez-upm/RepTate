name: Build binaries

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-docs:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # important if you later use setuptools-scm to get the version from git tags

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install docs dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install -r docs/requirements.txt
          python -m pip install sphinx
      
      - name: Install RepTate (editable) so Sphinx can read the version and other metadata
        run: |
          python -m pip install -e .

      - name: Set build date for docs
        run: |
          echo "REPTATE_BUILD_DATE=$(date -u +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Build Sphinx HTML docs
        run: |
          python -m sphinx -b html docs/source docs/build/html

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: reptate-docs-html
          path: docs/build/html

  build-windows:
    needs: build-docs
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
            fetch-depth: 0 # important if you later use setuptools-scm to get the version from git tags
            fetch-tags: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: reptate-docs-html
          path: docs_html

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install Nuitka

      - name: Build UI (uic + rcc + patch imports)
        run: |
          python scripts/build_ui.py

      - name: Install RepTate (editable) so that Nuitka can read the version and other metadata
        run: |
          python -m pip install -e .

      - name: Build with Nuitka (Windows)
        shell: cmd
        run: |
          python -m nuitka ^
            --assume-yes-for-downloads ^
            --mode=standalone ^
            --enable-plugin=pyside6 ^
            --windows-console-mode=disable ^
            --windows-icon-from-ico=RepTate\gui\Images\Reptate64.ico ^
            --output-dir=dist ^
            --noinclude-qt-translations ^
            --python-flag=-m ^
            --include-package=RepTate.tools ^
            --include-module=RepTate.gui.Reptate_rc ^
            --include-module=RepTate.gui.About_rc ^
            --include-module=RepTate.gui.Theory_rc ^
            --include-module=RepTate.gui.Tool_rc ^
            --include-module=RepTate.gui.MainWindow_rc ^
            --include-data-dir=data=data ^
            --include-data-dir=RepTate\gui\Images=RepTate\gui\Images ^
            --include-data-files=RepTate\tools\*.npy=RepTate\tools\ ^
            --include-data-files=RepTate\theories\*.npz=RepTate\theories\ ^
            --include-data-files=RepTate\theories\*_win32*.so=RepTate\theories\ ^
            RepTate

      - name: Add docs into dist folder (Windows)
        shell: pwsh
        run: |
          $distDir = Get-ChildItem -Path "dist" -Directory | Where-Object { $_.Name -like "*.dist" } | Select-Object -First 1
          if (-not $distDir) { throw "No *.dist directory found under dist/" }

          $target = Join-Path $distDir.FullName "docs\build\html"
          if (Test-Path (Join-Path $distDir.FullName "docs")) { Remove-Item (Join-Path $distDir.FullName "docs") -Recurse -Force }
          New-Item -ItemType Directory -Path $target | Out-Null
          Copy-Item -Path "docs_html\*" -Destination $target -Recurse -Force

      - name: Zip artifact (Windows)
        shell: pwsh
        run: |
          $zip = "RepTate-${{ github.ref_name }}-windows.zip"
          $distDir = Get-ChildItem -Path "dist" -Directory | Where-Object { $_.Name -like "*.dist" } | Select-Object -First 1
          if (-not $distDir) { throw "No *.dist directory found under dist/" }
          if (Test-Path "dist\$zip") { Remove-Item "dist\$zip" -Force }
          Compress-Archive -Path $distDir.FullName -DestinationPath "dist\$zip"
          "ZIP=$zip" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - uses: actions/upload-artifact@v4
        with:
          name: RepTate-${{ github.ref_name }}-windows
          path: dist/${{ env.ZIP }}

  build-linux:
    needs: build-docs
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # important if you later use setuptools-scm to get the version from git tags
          fetch-tags: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: reptate-docs-html
          path: docs_html

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install Nuitka

      - name: Build UI (uic + rcc + patch imports)
        run: |
          python scripts/build_ui.py

      - name: Install RepTate (editable) so that Nuitka can read the version and other metadata
        run: |
          python -m pip install -e .

      - name: Build with Nuitka (Linux)
        shell: bash
        run: |
          python -m nuitka \
            --mode=standalone \
            --enable-plugin=pyside6 \
            --linux-icon=RepTate/gui/Images/RepTate_logo_new.png \
            --output-dir=dist \
            --noinclude-qt-translations \
            --python-flag=-m \
            --include-package=RepTate.tools \
            --include-module=RepTate.gui.Reptate_rc \
            --include-module=RepTate.gui.About_rc \
            --include-module=RepTate.gui.Theory_rc \
            --include-module=RepTate.gui.Tool_rc \
            --include-module=RepTate.gui.MainWindow_rc \
            --include-data-dir=data=data \
            --include-data-dir=RepTate/gui/Images=RepTate/gui/Images \
            --include-data-files=RepTate/tools/*.npy=RepTate/tools/ \
            --include-data-files=RepTate/theories/*.npz=RepTate/theories/ \
            --include-data-files=RepTate/theories/*_linux*.so=RepTate/theories/ \
            RepTate

      - name: Add docs into dist folder (Linux)
        shell: bash
        run: |
          OUTDIR="$(find dist -maxdepth 2 -type d -name '*.dist' | head -n 1)"
          test -n "$OUTDIR"
          rm -rf "$OUTDIR/docs"
          mkdir -p "$OUTDIR/docs/build/html"
          cp -a docs_html/. "$OUTDIR/docs/build/html/"

      - name: Zip artifact (Linux)
        shell: bash
        run: |
          ZIP="RepTate-${{ github.ref_name }}-linux.zip"
          OUTDIR="$(find dist -maxdepth 2 -type d -name '*.dist' | head -n 1)"
          test -n "$OUTDIR"
          rm -f "dist/$ZIP"
          (cd "$(dirname "$OUTDIR")" && zip -r "$GITHUB_WORKSPACE/dist/$ZIP" "$(basename "$OUTDIR")")
          echo "ZIP=$ZIP" >> "$GITHUB_ENV"

      - uses: actions/upload-artifact@v4
        with:
          name: RepTate-${{ github.ref_name }}-linux
          path: dist/${{ env.ZIP }}

  build-macos:
    needs: build-docs
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # important if you later use setuptools-scm to get the version from git tags
          fetch-tags: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: reptate-docs-html
          path: docs_html

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install Nuitka

      - name: Build UI (uic + rcc + patch imports)
        run: |
          python scripts/build_ui.py

      - name: Install RepTate (editable) so that Nuitka can read the version and other metadata
        run: |
          python -m pip install -e .

      - name: Build with Nuitka (macOS)
        shell: bash
        run: |
          python -m nuitka \
            --mode=standalone \
            --enable-plugin=pyside6 \
            --macos-app-icon=RepTate/gui/Images/RepTate_logo_new.icns \
            --output-dir=dist \
            --noinclude-qt-translations \
            --python-flag=-m \
            --include-package=RepTate.tools \
            --include-module=RepTate.gui.Reptate_rc \
            --include-module=RepTate.gui.About_rc \
            --include-module=RepTate.gui.Theory_rc \
            --include-module=RepTate.gui.Tool_rc \
            --include-module=RepTate.gui.MainWindow_rc \
            --include-data-dir=data=data \
            --include-data-dir=RepTate/gui/Images=RepTate/gui/Images \
            --include-data-files=RepTate/tools/*.npy=RepTate/tools/ \
            --include-data-files=RepTate/theories/*.npz=RepTate/theories/ \
            --include-data-files=RepTate/theories/*_darwin*.so=RepTate/theories/ \
            RepTate

      - name: Add docs into app/dist folder (macOS)
        shell: bash
        run: |
          OUTDIR="$(find dist -maxdepth 2 -type d \( -name '*.app' -o -name '*.dist' \) | head -n 1)"
          test -n "$OUTDIR"
          rm -rf "$OUTDIR/docs"
          mkdir -p "$OUTDIR/docs/build/html"
          cp -a docs_html/. "$OUTDIR/docs/build/html/"

      - name: Zip artifact (macOS)
        shell: bash
        run: |
          ZIP="RepTate-${{ github.ref_name }}-macos.zip"
          OUTDIR="$(find dist -maxdepth 2 -type d \( -name '*.app' -o -name '*.dist' \) | head -n 1)"
          test -n "$OUTDIR"
          rm -f "dist/$ZIP"
          (cd "$(dirname "$OUTDIR")" && zip -r "$GITHUB_WORKSPACE/dist/$ZIP" "$(basename "$OUTDIR")")
          echo "ZIP=$ZIP" >> "$GITHUB_ENV"

      - uses: actions/upload-artifact@v4
        with:
          name: RepTate-${{ github.ref_name }}-macos
          path: dist/${{ env.ZIP }}

  release:
    needs: [build-docs, build-windows, build-linux, build-macos]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v4

      - uses: softprops/action-gh-release@v2
        with:
          files: |
            **/*.zip
            
            